# 版本历史

本文档记录了 BaiduPCS-Rust 的所有版本更新历史。

## v1.8.0 (当前版本)

**新功能：**
- ✨ **离线下载功能**：支持通过百度网盘服务器代为下载资源到网盘空间
    - 支持多种下载链接格式：HTTP/HTTPS、磁力链接（magnet）、ed2k 链接
    - 磁力链接自动标准化：Base32 编码自动转换为十六进制，小写转大写
    - 任务管理：添加、查询、取消、删除离线下载任务
    - 实时进度显示：通过 WebSocket 实时推送任务状态和进度更新
    - **自动下载功能**：任务完成后可自动下载到本地，支持配置保存路径和每次询问路径选项
    - 智能轮询机制：根据任务进度预测完成时间，动态调整轮询间隔（最小 3 分钟，最大 60 分钟）
    - 任务详情查看：支持查看任务的完整信息，包括文件列表、保存路径、源链接等

**问题修复：**
- 🐛 **修复文件夹下载完成计数问题**：使用 `counted_task_ids` HashSet 避免重复计数已完成任务，修复已完成任务从内存移除后 `completed_count` 统计错误的问题
- 🐛 **修复已取消文件夹仍显示在列表中**：取消文件夹时从 `folders` HashMap 中移除，避免已取消的文件夹任务继续显示在任务列表中
- 🐛 **修复文件夹下载进度统计**：已完成任务从内存移除后，使用文件夹自身维护的 `completed_count` 和 `downloaded_size` 字段统计进度，而不是从已清空的 `tasks` 列表计算
- 🐛 **修复文件夹下载任务完成通知**：通知消息包含 `(group_id, task_id)` 元组，确保已完成任务能正确识别和处理，避免依赖已从内存移除的任务信息

**技术改进：**
- 🔧 **自动备份轮询抖动**：
    - 间隔轮询：添加 ±20% 的随机抖动，最小间隔 10 分钟
    - 定时轮询：添加 ±5 分钟的随机抖动
    - 首次启动：添加 0-25% 的随机延迟，避免重启后立即请求
    - 防止固定间隔被风控识别，降低账号风险
- 🔧 **文件夹下载管理器优化**：
    - 新增 `get_all_folders_with_history()` 方法，合并内存和历史数据库中的文件夹任务
    - 新增 `clear_completed_folders()` 方法，清理内存中已完成的文件夹任务
    - 优化任务完成监听器，直接使用收到的 `task_id` 处理，不依赖已从内存移除的任务信息
- 🔧 **离线下载监听服务**：
    - 智能轮询间隔计算：根据任务进度预测完成时间，提前 20% 检查
    - 双模式轮询：实时监听模式（用户在页面）和自动下载模式（后台运行）
    - 进度追踪器：使用滑动窗口（最多 5 条记录）计算下载速度，预测完成时间
    - WebSocket 订阅者计数：根据订阅者数量动态调整轮询频率

---

## v1.7.0

**新功能：**
- ✨ **Web 访问认证**：为 Web 界面提供访问保护机制
    - 密码保护：支持为 Web 界面设置访问密码，防止未授权访问
    - TOTP 双因素认证：支持 Google Authenticator 等 TOTP 应用，增强安全性
    - Token 管理：访问令牌 + 刷新令牌机制，支持自动续期
    - 登录安全：速率限制和账户锁定保护，防止暴力破解
    - 恢复码机制：丢失 TOTP 设备时可使用一次性恢复码登录

**问题修复：**
- 🐛 **修复自动备份任务复用问题**：修复复用任务时旧的待完成任务ID未清理，导致与新创建的任务ID混淆的问题
- 🐛 **修复下载去重记录失败问题**：修复备份下载完成时 `fs_id` 获取失败的问题，优先从 `BackupFileTask` 获取，避免从已清理的 `DownloadManager` 获取
- 🐛 **修复下载解密阻塞调度问题**：将解密操作异步化，spawn 到独立线程执行，不再阻塞调度循环
- 🐛 **修复下载任务启动失败问题**：备份任务和文件夹子任务启动失败后支持自动重试（最多3次），并正确释放已分配的槽位

**技术改进：**
- 🔧 **解密并发控制**：使用信号量限制同时解密的文件数，根据 CPU 核心数动态计算（2-8个），避免内存和 CPU 过载
- 🔧 **下载任务重试机制**：新增 `start_retry_count` 字段，支持任务启动失败后放回等待队列重试

---

## v1.6.0

**主要功能：**
- ✨ **自动备份功能**：支持本地文件夹自动备份到百度网盘
    - 支持上传备份（本地 → 云端）和下载备份（云端 → 本地）两种方向
    - 文件系统监听：实时检测本地文件变化（Windows 使用 ReadDirectoryChangesW）
    - 定时轮询兜底：防止监听遗漏，支持间隔轮询和指定时间全量扫描
    - 备份配置管理：创建/编辑/删除备份配置、手动触发备份、禁用/启用
    - 备份历史记录：查看已完成的备份任务历史
    - SQLite 持久化：备份任务断点恢复
- ✨ **客户端侧加密**：支持普通上传任务和自动备份任务
    - AES-256-GCM 加密算法，端到端加密保护文件隐私
    - 加密密钥管理：生成、导出、删除密钥
    - 加密文件使用 `.dat` 扩展名隐藏真实文件类型
    - 加密快照管理：记录加密文件映射关系，支持下载自动解密

**技术改进：**
- 🔧 **任务槽池机制重构**：从下载模块提取为公共模块，上传模块也采用统一的任务槽机制
- 🔧 **优先级调度支持**：任务槽池支持普通任务、子任务、备份任务三级优先级，普通任务可抢占备份任务槽位
- 🔧 **历史记录数据库化**：从 JSONL 文件迁移到 SQLite，提升查询性能
- 🔧 **内存监控模块**：新增内存监控能力
- 🔧 上传/下载引擎支持加密功能集成
- 🔧 新增 ARM64 Docker 镜像构建支持

---

## v1.5.1

**问题修复：**
- 🐛 修复若干 bug

**功能改进：**
- ✨ 系统页面选择下载目录支持文件资源管理器

---

## v1.5.0

**主要功能：**
- ✨ **任务持久化**：新增 WAL + 元数据的持久化管理器，支持后台批量刷写、断点恢复与优雅关闭（下载/上传/转存任务重启可恢复）
- ✨ **移动端适配**：主布局新增移动端抽屉导航与底部 Tab 栏，响应式样式覆盖文件/下载/上传/转存/设置页
- ✨ **日志持久化与滚动**：支持日志文件落盘、按大小滚动和保留天数配置，默认启用
- ✨ **任务槽机制**：下载引入任务槽（固定位+借调位）机制，替代预注册机制，保证并发可控
- ✨ **WebSocket 实时推送**：任务状态可实时刷新

---

## v1.4.0

**主要功能：**
- ✨ **转存分享链接功能**：支持转存百度网盘分享链接到自己的网盘，支持提取码验证，可选择转存后自动下载
- ✨ **CDN链接刷新三层检测机制**：
    - 显著提升下载稳定性和速度
- ✨ **批量上传和批量下载**：支持在文件管理页面多选文件/文件夹进行批量操作
- ✨ **下载文件资源管理器**：下载时可通过文件资源管理器选择保存目录，支持最近目录记忆
- ✨ **上传下载最近目录功能**：自动记录最近使用的上传/下载目录，下次操作时自动定位
- ✨ **统一上传按钮**：上传文件和上传文件夹使用同一个按钮，简化操作流程

**问题修复：**
- 🐛 **修复下载文件夹暂停问题**：修复了下载文件夹时暂停操作，子文件仍在继续下载的问题

**技术改进：**
- 🧩 后端新增 `transfer` 模块，实现分享链接解析、验证和转存功能
- 🧩 后端新增 三层检测机制
- 🧩 优化下载引擎，集成CDN链接自动刷新机制，提升下载稳定性
- 🧩 前端优化 FilePicker 组件，支持下载目录选择模式
- 🧩 前端优化 FilesView，支持批量选择和批量操作

---

## v1.3.1

**问题修复：**
- 🐛 **修复系统设置页面下载路径不生效问题**：在系统设置中修改下载路径后，现在会立即动态更新下载管理器和文件夹下载管理器的下载目录，无需重启应用即可生效
- 🔧 **优化健康检查配置**：调整 Docker 健康检查参数

**技术改进：**
- 🧩 在配置更新 API 中增加动态更新下载目录的逻辑，确保配置修改后立即生效
- 🧩 优化下载管理器和文件夹下载管理器的下载目录更新机制，支持运行时动态切换

---

## v1.3.0

**主要功能：**
- ✨ **上传引擎与上传任务管理页面**：支持查看全部上传任务、进度、速度和剩余时间
- ✨ **集成本地文件资源管理器**：用于选择本地文件或文件夹作为上传源，支持路径导航与分页加载
- ✨ **上传任务控制**：支持暂停、继续、重试和删除操作，并在支持秒传的场景下显示"秒传"状态
- ✨ **百度网盘新建文件夹功能**：支持在网盘中创建新文件夹（⚠️ 可能需要重新登入才可使用）

**前后端改进：**
- 🧩 后端新增 `uploader` 模块与本地文件系统访问模块，负责上传任务的调度与状态管理
- 🧩 前端新增 `上传管理` 页面与 `FilePicker` 组件，并与文件管理页面打通"上传"入口

**文档与截图更新：**
- 📝 更新 README 增加上传相关功能说明与界面预览
- 🖼️ 新增上传管理、文件上传对话框、上传设置等界面截图

---

## v1.2.1

**性能优化：**
- 🚀 **并发优化**：重构热点访问路径，消除锁竞争瓶颈，提升多任务场景下的吞吐
- ⚖️ **动态加权分片调度**：根据实时带宽与分片健康度自适应调度，显著提升下载平滑度

**稳定性增强：**
- 🔁 **重试指数退避**：失败重试采用指数退避 + 抖动策略，降低瞬时失败放大效应
- 🧠 **任务级并发控制**：为单任务设置细粒度并发上限，避免少量大任务占用全部资源

---

## v1.2.0

**主要功能：**
- ✨ **文件夹下载功能**：支持递归下载整个文件夹，自动扫描并创建所有文件的下载任务
- ✨ **混合任务列表**：文件和文件夹下载任务统一显示，支持聚合进度显示

**优化改进：**
- 🚀 **URL淘汰策略优化**：
    - 实现 LinkState 权重结构，智能管理下载链接
    - 使用 score 评分机制（0-100）评估链接健康状态
    - 速度追踪双轨制：短期窗口 median + EWMA 长期统计
    - 优化 chunk 下载完成逻辑，使用 lazy probe 机制
    - 显著提升下载平滑度和稳定性

**文档更新：**
- 📝 完善 README 配置说明，添加普通用户和 SVIP 配置建议

---

## v1.1.1

**问题修复：**
- 🐛 优化下载调度器，修复下载速度慢的问题

**其他：**
- 🧹 移除未使用的 docker-build.yml workflow 文件

---

## v1.1.0

**配置功能优化：**
- ✅ **强制使用绝对路径**：下载目录从相对路径改为必须使用绝对路径
    - 配置文件验证：保存配置时验证下载目录是否为绝对路径
    - 路径格式检查：Windows 示例 `D:\Downloads`，Linux/Docker 示例 `/app/downloads`
    - 自动路径解析：默认配置会根据运行环境（Docker/本地）自动生成绝对路径

- ✅ **路径验证增强**：新增完整的路径验证功能
    - 新增 `PathValidator` 模块：验证路径存在性、可写性、可用空间
    - 新增 `EnvDetector` 模块：检测运行环境（Docker/本地、操作系统类型）
    - 新增 `MountDetector` 模块：检测挂载点信息
    - 保存配置前进行完整验证，确保路径可用

- ✅ **配置功能优化**：
    - 改进配置加载逻辑，自动验证路径格式
    - 保存配置时返回详细的路径验证结果
    - 首次启动时自动创建默认下载目录（如果不存在）
    - 优化错误提示，提供清晰的路径格式说明

**前端界面改进：**
- ✅ **设置页面优化**：
    - 更新下载目录配置说明，明确要求使用绝对路径
    - 改进错误提示信息，显示路径格式要求
    - 增强下载目录配置的用户体验

**下载器改进：**
- ✅ **下载管理器优化**：
    - 改进日志输出，显示下载目录路径
    - 优化目录创建逻辑和日志提示

**问题修复：**
- 🐛 修复 mount detector vector 类型注解问题

**文档：**
- 📝 添加贡献指南并优化配置功能说明

---

## v1.0.0

**初始版本发布：**
- ✨ 基础架构搭建
- ✨ 二维码扫码登录功能
- ✨ 文件浏览和管理
- ✨ 单文件下载引擎（多线程 + 断点续传）
- ✨ Web 服务器（RESTful API）
- ✨ 前端界面（Vue 3 + Element Plus）
- ✨ Docker 部署支持

